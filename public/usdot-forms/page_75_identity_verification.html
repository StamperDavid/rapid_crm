<!-- FMCSA USDOT Application - Page 75: Identity Verification (IDEMIA) -->
<!-- form_welcome - ADMIN IDENTITY VERIFICATION PAGE -->
<!-- NEW FLOW: Admin verifies their own identity (not client) -->
<!-- PROGRESS: 99% - ALMOST COMPLETE! -->

<!-- PAGE TITLE -->
<div class="pageTitleDiv">
  <span class="heavy">IDENTITY VERIFICATION - ADMIN REQUIRED</span>
</div>

<!-- MAIN CONTENT TABLE -->
<table width="100%">
  <tr>
    <td align="center" colspan="2">
      <p>
        To strengthen the security of your information within our systems, the Federal Motor Carrier Safety 
        Administration (FMCSA) has implemented a new identity verification process. This is designed to protect 
        your data and ensure secure access to your company information.
      </p>
      <br>
    </td>
  </tr>

  <tr>
    <!-- LEFT COLUMN: Instructions -->
    <td style="vertical-align:top;">
      <p>
        <u><span style="color:red; font-weight: bold;">Action Required:</span></u> 
        To continue with this application, the authorized admin must complete identity verification.
        <br><br>
        <u><span style="color:red; font-weight: bold;">Please Note:</span></u> 
        If you have already completed identity verification using your Login.gov credentials to register an 
        application in URS, you are not required to complete verification again. Please click the 
        <span style="font-weight: bold;">'Click Here to Proceed'</span> button below to continue.
        <br><br>
        <u><span style="color:#003366; font-weight: bold;">For Automated Filings:</span></u>
        When filing on behalf of a client, the admin (not the client) must complete this verification step.
        <br><br>
        Please follow these steps:
        <br>
      </p>
      <br>
      
      <!-- INSTRUCTIONS LIST -->
      <dl>
        <!-- Step 1: Admin Prepares ID Document -->
        <dt><span style="font-weight: bold;">1. Prepare Your Government-Issued ID</span></dt>
        <dd style="padding-left:20px;">
          Have your driver's license, passport, or state ID ready for verification.
          This must be the admin's ID who is authorized to file applications.
        </dd>
        <br>
        
        <!-- Step 2: Complete Verification Process -->
        <dt><span style="font-weight: bold;">2. Complete Identity Verification:</span></dt>
        <dd style="padding-left:20px;">
          <strong>Option A: Biometric Verification (Recommended)</strong>
          <br>
          - Click "Begin Verification" button below
          <br>
          - Follow prompts to capture ID photo and selfie
          <br>
          - Complete facial recognition verification
          <br><br>
          <strong>Option B: Visit Enrollment Center</strong>
          <br>
          - Visit a physical enrollment center for in-person verification
          <br>
          - Your verification will be saved for all future applications
          <br><br>
          <a href="https://www.fmcsa.dot.gov/registration/identity-verification-enrollment-center-locations" 
             target="fmcsaidemiaenroll" 
             rel="noopener noreferrer">
            Click Here
          </a> 
          to view a complete list of Enrollment Centers.
        </dd>
        <br>
        
        <!-- Step 3: Admin Checkpoint Notice -->
        <dt><span style="font-weight: bold;">3. Admin Verification Checkpoint</span></dt>
        <dd style="padding-left:20px;">
          <div style="background-color:#fff3cd; border:1px solid #ffc107; padding:12px; border-radius:4px;">
            <strong>‚ö†Ô∏è RPA CHECKPOINT</strong><br>
            For automated filings, the RPA agent will pause at this step and notify the admin.
            The admin must complete verification before the application can proceed.
          </div>
        </dd>
        <br>
        
        <!-- Step 4: Confirm Verification -->
        <dt><span style="font-weight: bold;">4. Confirm Verification</span></dt>
        <dd style="padding-left:20px;">
          Once your identity has been verified, please 
          <span class="idemia">
            <a href="#" 
               onclick="handleButton('idemia');" 
               style="text-decoration:none;color:white;font-size:large;">
              Click Here to Proceed
            </a>
          </span>
        </dd>
      </dl>
      <br>
      
      <!-- Contact Info -->
      <p>
        If you encounter issues with the Identity Verification process, please call the Contact Center 
        at (1-800-832-5660) for assistance.
      </p>
      <br>
      
      <!-- Thank You -->
      <p>
        Thank you for your cooperation in helping us maintain the highest standards of security and 
        protection of your data.
      </p>
    </td>

    <!-- RIGHT COLUMN: Admin Verification Panel -->
    <td style="vertical-align:top; padding-left:20px;">
      <table width="100%" style="border:2px solid #003366; background-color:#f8f9fa; padding:15px;">
        <tr>
          <td>
            <h3 style="color:#003366; margin-top:0;">Admin Identity Verification</h3>
            
            <!-- Verification Status -->
            <div id="verificationStatus" style="margin:15px 0;">
              <div style="background-color:#d1ecf1; border:1px solid #17a2b8; padding:10px; border-radius:4px;">
                <strong>Status:</strong> <span id="statusText">Not Verified</span>
              </div>
            </div>
            
            <!-- Admin Info -->
            <div style="margin:15px 0; padding:10px; background-color:white; border:1px solid #ddd; border-radius:4px;">
              <p><strong>Authorized Admin:</strong></p>
              <p id="adminName" style="margin:5px 0 0 0;">Loading...</p>
              <p id="adminEmail" style="margin:5px 0 0 0; color:#666;">Loading...</p>
            </div>
            
            <!-- Verification Options -->
            <div style="margin:20px 0;">
              <button 
                id="beginVerificationBtn"
                onclick="beginIDEMIAVerification();" 
                style="width:100%; padding:12px; background-color:#28a745; color:white; border:none; border-radius:4px; font-size:16px; font-weight:bold; cursor:pointer; margin-bottom:10px;">
                üîí Begin Biometric Verification
              </button>
              
              <button 
                id="skipVerificationBtn"
                onclick="skipVerification();" 
                style="width:100%; padding:12px; background-color:#6c757d; color:white; border:none; border-radius:4px; font-size:14px; cursor:pointer; margin-bottom:10px;">
                ‚úì I'm Already Verified - Proceed
              </button>
            </div>
            
            <!-- Verification Requirements -->
            <div style="margin:15px 0; font-size:12px; color:#666;">
              <p><strong>What you'll need:</strong></p>
              <ul style="margin:5px 0; padding-left:20px;">
                <li>Government-issued photo ID</li>
                <li>Webcam or smartphone camera</li>
                <li>Good lighting for photo capture</li>
                <li>5-10 minutes to complete</li>
              </ul>
            </div>
            
            <!-- Security Notice -->
            <div style="margin:15px 0; padding:10px; background-color:#f0f0f0; border-left:4px solid #003366; font-size:11px;">
              <strong>üîê Security Notice:</strong><br>
              Your biometric data is processed by IDEMIA, a FMCSA-approved third-party provider. 
              Verification is stored securely and valid for all future applications.
            </div>
            
            <!-- Technical Requirements -->
            <div style="margin:10px 0; text-align:center; font-size:11px;">
              <a href="https://www.fmcsa.dot.gov/faq/what-are-minimum-user-technical-requirements-id-verification-process" 
                 target="fmcsaidemiatech" 
                 rel="noopener noreferrer"
                 style="color:#003366;">
                View Technical Requirements ‚Üí
              </a>
            </div>
          </td>
        </tr>
      </table>
      
      <!-- RPA Automation Notice -->
      <div style="margin-top:20px; padding:12px; background-color:#e7f3ff; border:1px solid #0066cc; border-radius:4px; font-size:12px;">
        <strong style="color:#0066cc;">ü§ñ For Automated Filings:</strong><br>
        When using RPA automation, the system will pause here and send a notification to the admin.
        The admin will have 30 minutes to complete verification before the filing times out.
      </div>
    </td>
  </tr>
</table>

<!-- JavaScript for Verification Functions -->
<script>
  // Simulate loading admin info
  window.addEventListener('load', function() {
    // In production, this would load from session/API
    document.getElementById('adminName').textContent = 'Admin User';
    document.getElementById('adminEmail').textContent = 'admin@rapidcrm.com';
  });
  
  function beginIDEMIAVerification() {
    // In production, this would launch IDEMIA verification flow
    alert('IDEMIA Verification would launch here.\n\nIn training mode, this is simulated.\n\nFor production, this would:\n1. Open IDEMIA biometric verification\n2. Capture ID document photos\n3. Perform facial recognition\n4. Verify liveness detection\n5. Return verification result');
    
    // Simulate successful verification
    document.getElementById('statusText').textContent = 'Verified ‚úì';
    document.getElementById('verificationStatus').innerHTML = '<div style="background-color:#d4edda; border:1px solid #28a745; padding:10px; border-radius:4px;"><strong>Status:</strong> <span style="color:#28a745;">‚úì Verified</span></div>';
  }
  
  function skipVerification() {
    // Check if admin is already verified in database
    alert('Checking verification status...\n\nIn production, this would:\n1. Query employee_identity_documents table\n2. Check idemia_verification_status = "verified"\n3. If verified, allow skip\n4. If not verified, require new verification');
    
    // Simulate already verified
    document.getElementById('statusText').textContent = 'Previously Verified ‚úì';
    document.getElementById('verificationStatus').innerHTML = '<div style="background-color:#d4edda; border:1px solid #28a745; padding:10px; border-radius:4px;"><strong>Status:</strong> <span style="color:#28a745;">‚úì Previously Verified</span></div>';
  }
</script>

<!-- METADATA -->
<!--
Form ID: form_welcome
Progress: 99% (JUMPED from 95% - up 4 percentage points!)

UPDATED: ADMIN IDENTITY VERIFICATION PAGE

CRITICAL CHANGE: 
- OLD FLOW: Client scans QR code and verifies their identity
- NEW FLOW: Admin (employee filing the application) verifies their own identity
- REASON: For automated RPA filings, the admin is performing the filing, not the client

IDEMIA BIOMETRIC SYSTEM:
- Third-party identity verification provider
- Biometric verification (facial recognition + ID document)
- Admin verification stored in employee_identity_documents table
- One-time verification valid for all future filings

TWO VERIFICATION OPTIONS:

OPTION 1: BIOMETRIC VERIFICATION (RECOMMENDED)
- Admin clicks "Begin Biometric Verification" button
- Launches IDEMIA verification flow
- Steps:
  1. Upload/photograph government-issued ID (front and back if DL)
  2. Take live selfie for facial recognition
  3. Complete liveness detection (anti-spoofing)
  4. System verifies ID authenticity and matches face
- Verification result stored in employee_identity_documents table
- idemia_verification_status = 'verified'
- Valid for all future applications (no re-verification needed)

OPTION 2: IN-PERSON ENROLLMENT CENTER
- Visit physical enrollment center location
- In-person biometric capture by FMCSA representative
- Verification linked to employee account
- Link: https://www.fmcsa.dot.gov/registration/identity-verification-enrollment-center-locations

SKIP LOGIC:
"If you have already completed identity verification..."
- Admin can click "I'm Already Verified - Proceed"
- System checks employee_identity_documents table
- If idemia_verification_status = 'verified', allow skip
- If not verified or expired, require new verification

RPA CHECKPOINT HANDLING:

FOR TRAINING ENVIRONMENT:
1. Display checkpoint notice
2. Show simulation controls:
   - "Complete Verification" button (simulates instant verification)
   - "Skip (Already Verified)" button (simulates previous verification)
   - "Simulate Failure" button (tests error handling)
3. Training can proceed after simulation button clicked
4. Expected duration: 30 seconds in training vs 5-10 minutes in production

FOR LIVE PRODUCTION:
1. RPA agent pauses execution at this step
2. Creates checkpoint in database:
   - rpa_checkpoints table
   - checkpoint_type = 'admin_identity_verification'
   - status = 'waiting'
3. Sends notification to admin:
   - Email alert
   - Dashboard notification
   - SMS (optional)
4. Admin has 30 minutes to complete verification
5. Options:
   A. Complete new verification (5-10 minutes)
   B. Click skip if already verified (instant)
   C. Verification times out ‚Üí RPA fails gracefully
6. After verification:
   - Update checkpoint status = 'completed'
   - RPA agent resumes from next step
   - Application proceeds to submission

DATABASE INTEGRATION:

employee_identity_documents table:
- Stores admin ID document photos
- Tracks IDEMIA verification status
- Links to employee_id (admin user)

admin_idemia_verifications table:
- Logs each verification session
- Tracks verification attempts
- Links to deal_id and rpa_instance_id
- Stores duration and result

rpa_audit_trail table:
- Logs checkpoint creation
- Logs admin notification sent
- Logs verification completion
- Logs resumption of RPA

BUTTON TO PROCEED:
- Class: "idemia" (styled button - blue background, white text, rounded corners)
- onclick: handleButton('idemia')
- Text: "Click Here to Proceed"
- Only enabled AFTER verification completed/skipped

TECHNICAL REQUIREMENTS LINK:
- https://www.fmcsa.dot.gov/faq/what-are-minimum-user-technical-requirements-id-verification-process
- Target: "fmcsaidemiatech"
- Opens in new window

MENU BUTTON STATUS:
- PREVIOUS: DISABLED (dijitMenuItemDisabled dijitDisabled, aria-disabled="true")
  - Cannot go back from identity verification
  - Must complete verification or logout
- NEXT: Disabled until verification complete

SECURITY FEATURES:
1. Government system warning (footer)
2. Privacy Act notice (footer)
3. Third-party biometric verification (IDEMIA)
4. Admin ID stored encrypted
5. Session-specific verification tracking

REGULATORY COMPLIANCE:
- Login.gov integration mentioned (government identity system)
- FMCSA-mandated identity verification
- Prevents fraudulent applications
- Enhances data security
- Admin accountability for filings

CONTACT CENTER:
Phone: 1-800-832-5660
For assistance with identity verification issues

FORM DIMENSIONS:
width: 1690px; height: 768px

PROGRESS:
99% complete! Only 1% remaining!
This is likely the FINAL or SECOND-TO-LAST page before 100%!

CRITICAL IMPLEMENTATION NOTE FOR TRAINING SYSTEM:
1. Display this page when RPA reaches step 75
2. Show checkpoint indicator in training UI
3. Provide simulation controls:
   - "‚úì Complete Verification" (instant in training)
   - "Skip (Already Verified)" (instant in training)
   - "Simulate Verification Failure" (test error handling)
4. Track verification in training session
5. Allow resume after simulation completed
6. In training mode: 30 second delay instead of 5-10 minutes
7. Test timeout handling (if simulation not completed in X seconds)

UPDATED WORKFLOW:
Old Step 6: QR Code Client Handoff ‚ùå
New Step 6: Admin Identity Verification ‚úì

This aligns with the business model where:
- Rapid CRM files applications on behalf of clients
- Admin (not client) needs to be verified as authorized filer
- Client never sees or interacts with FMCSA website
- One-time admin verification for all client filings
-->

